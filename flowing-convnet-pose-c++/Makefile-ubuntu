P=video_pose_overlay

INCLUDES=-I../caffe/include -I../caffe/build/include -I/usr/include/openblas -I./inc
CXXFLAGS=-ggdb3 -Wall -Wextra -O3 -DCPU_ONLY=1 -DBLAS=open -std=gnu++11 -fcolor-diagnostics -fPIC $(INCLUDES) # -Werror
LDLIBS=-L../caffe/build/lib -lcaffe -lopencv_core -lopencv_highgui -lopencv_imgproc -lopencv_video -lboost_system -lglog
LDFLAGS=-Wl,-R../caffe/build/lib
CXX=clang++-3.5
CC=clang++-3.5
SOURCE=src/$(P).cpp src/estimate_pose.cpp
OBJECTS=$(patsubst %.cpp,obj/%.o,$(notdir $(SOURCE)))
EXECUTABLE=bin/$(P)
C_WRAPPER=estimate_pose_wrapper
SHARED_LIB=lib/lib$(C_WRAPPER).so.1.0.1

shared_lib: $(SHARED_LIB)
shared_lib: CXXFLAGS += -fPIC

all: $(EXECUTABLE)

obj/%.o: src/%.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@

$(EXECUTABLE): $(OBJECTS)
	$(CXX) $(LDFLAGS) -o $@ $(OBJECTS) $(LDLIBS)

$(SHARED_LIB): src/$(C_WRAPPER).c $(OBJECTS)
	$(CC) -fPIC -ggdb3 -c -O3 $(INCLUDES) src/$(C_WRAPPER).c -o obj/$(C_WRAPPER).o
	$(CC) -shared -fPIC -Wl,-soname,lib$(C_WRAPPER).so.1 -o $(SHARED_LIB) obj/$(C_WRAPPER).o $(OBJECTS) -lc $(LDLIBS) $(LDFLAGS) -lstdc++

depend: .depend

.depend: $(SOURCE)
	$(RM) ./.depend
	$(CXX) $(CXXFLAGS) -MM $^>>./.depend;

clean:
	$(RM) $(OBJECTS)

dist-clean: clean
	$(RM) *~ .depend

include .depend
